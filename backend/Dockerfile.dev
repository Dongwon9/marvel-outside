# syntax=docker/dockerfile:1
FROM node:24

WORKDIR /workspace

# Install pnpm globally and PostgreSQL client tools
RUN corepack enable && \
  corepack prepare pnpm@latest --activate && \
  apt-get update && \
  apt-get install -y postgresql-client && \
  rm -rf /var/lib/apt/lists/*

# Copy workspace files for pnpm monorepo
COPY pnpm-workspace.yaml ./
COPY pnpm-lock.yaml ./
COPY package.json ./

# Copy backend package.json
COPY backend/package.json ./backend/

# Install dependencies using pnpm
RUN pnpm install --frozen-lockfile
RUN pnpm approve-builds

# Set working directory to backend
WORKDIR /workspace/backend

# Copy entrypoint script
COPY backend/scripts/docker-entrypoint.sh /workspace/docker-entrypoint.sh

# Make entrypoint script executable
RUN chmod +x /workspace/docker-entrypoint.sh

EXPOSE 3000

# Use entrypoint script to handle migrations and startup
ENTRYPOINT ["/workspace/docker-entrypoint.sh"]
